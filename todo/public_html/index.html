<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do App</title>

    <style>
        #create-task, #list-tasks {
            border: 1px dashed black;
        }
    </style>

    <!-- Load jQuery first, then html, and finally JS-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</head>

<body>

    <h1>To-Do App</h1>

    <div id="create-task">
        <h2>Create Task</h2>
        <label for="task-description">Task Description</label><br />
        <input type="text" id="task-description" /> <br />
        <label for="task-notes">Additional Notes</label> <br />
        <input type="text" id="task-notes" placeholder="(optional)" /> <br />
        <label for="task-due-date">Task Due Date</label> <br />
        <input type="date" id="task-due-date" value="2022-04-01"><br />
        <div id="priority">
            <p>Priority</p>
            <input type="radio" name="priority" id="low" value="1"/>
            <label for="low">Low</label><br />
            <input type="radio" name="priority" id="medium" checked="true" value="2"/>
            <label for="medium">Moderate</label><br />
            <input type="radio" name="priority" id="high" value="3"/>
            <label for="high">Urgent</label><br />
        </div>
        <button id="create-button">Create Task</button>
        <p id="message"></p>
    </div>

    <div id="list-tasks">
        <h2>To-Do List</h2>
        <ul id="tasks">
        </ul>
    </div>

    <!--JavaScript-->
    <script>
        //Code inside a $(document).ready() block will only run once the page Document Object Model(DOM) is ready for JavaScript code to execute.
        $(document).ready(function () {
            // //Set the due date on Create Task to today's date
            // let today = new Date();
            // let todayString = `${today.getFullYear()}-${today.getMonth().toString().padStart(2, "0")}-${today.getDate()}`;
            // console.log(todayString);

            // // set's Date input to today's date
            // $("#task-due-date").attr("value", todayString);

            //POST request to list the tasks on the web page
            $.post("http://localhost:3000/list", {}, function(response) {
                updateList(response.list);
            });

            //Run the following code when the user clicks the Create button...
            $("#create-button").click(function(){
                //Build an Object that holds the values provided by the user in the HTML forms. Generate time stamps as well.
                let newTask = {
                    description: $("#task-description").val(),
                    notes: $("#task-notes").val(),
                    dueDate: (new Date($("#task-due-date").val())).toString(),
                    created: (new Date()).toString(),
                    priority: $("input[name=priority]:checked").val(),
                    deleted: "",
                    completed: ""
                };
                //POST request to create the task. Send the newTask Object to the createTask Post handler.Console log the response of the server. 
                $.post("http://localhost:3000/createTask", newTask, function(response){
                    
                    $("#message").html(response.message);

                    if (response.error) {
                        $("#message").css("color", "red");
                    } else {
                        $("#message").css("color", "green");
                    }
                    
                    $.post("http://localhost:3000/list", {}, function(response) {
                        updateList(response.list);
                    });  
                });
            });

        });

        //This function will take in an array of Todo objects, and create an li element for each of them and place inside of the existing ul. This function deletes any existing items in the URL.
        function updateList(arrayList){
            
            $("#tasks").html("");

            for(let i = 0; i < arrayList.length; i++){
                let task = arrayList[i];
                
                let html = 
                `<li id="${task._id}">
                    Task: ${task.description}<br />
                    Due By: ${task.dueDate}<br />
                    Notes: ${task.notes}<br />
                    Priority: ${task.priority}<br />
                    <button class="edit-button">Edit</button>
                    <button class="complete-button">Complete</button>
                </li>`;
            
                $("#tasks").append(html);
            }

            $(".edit-button").click(function() {
                const task = $(this).parent();
                editTask(task);
            });

            $(".complete-button").click(function () {
                const task = $(this).parent();
                completeTask(task);
            });
        }

        function completeTask(taskLi) {
            let dataToSend = {
                _id: taskLi.attr("id")
            }

            $.post("http://localhost:3000/completeTask", dataToSend, function(response){
                console.log(response.success);

                if(response.success){
                    console.log("Task completed");
                } else {
                    console.log("Something happened in the backend");
                }
            });
        }

        function editTask(taskLi) {

            const dataToSend = {
                id: taskLi.attr("id")
            };
            //console.log(dataToSend);

            $.post("http://localhost:3000/getTask", dataToSend, function(response){

                console.log("Service response: " + response);

                let html = 
                `
                    Task: <input type="text" value="${response.description}"><br />
                    Due by: ${response.dueDate}<br />
                    Notes: <input type="text" value="${response.notes}"><br />
                    Priority: <input type="number" min="1" max="3" value="${response.priority}"<br />
                    <br />
                    <button class="cancel-button">Cancel</button>
                    <button class="save-button">Save Changes</button>
                `;

                taskLi.html(html);

                $(".cancel-button").click(function(){
                    cancelTask(taskLi, response);
                });
                
            });          
        }

        function cancelTask(taskLi, response) {
            
            let html = `
                Task: ${response.description}<br />
                Due by: ${response.dueDate}<br />
                Notes: ${response.notes}<br />
                Priority: ${response.priority}<br />
                <button class="edit-button">Edit</button>
                <button class="complete-button">Complete</button>
            `;

            taskLi.html(html);
            let newEditButton = taskLi.children(".edit-button");
            let newCompleteButton = taskLi.children(".complete-button");

            newEditButton.click(function() {
                editTask(taskLi);
            });

            newCompleteButton.click(function() {
                completeTask(taskLi);
            });
    }
    </script>
</body>

</html>